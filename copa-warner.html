<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Prix de Datos</title>
    <!-- Incluye Tailwind CSS CDN para estilos rápidos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ==========================================
           FUENTES
           ========================================== */
        /* Importa una fuente tipo arcade para el título y el botón */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        .font-arcade {
            font-family: 'Press Start 2P', cursive;
        }
        /* Importa una fuente monospace para el estilo de "reloj digital" */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        .font-digital {
            font-family: 'Roboto Mono', monospace;
        }

        /* ==========================================
           ESTILOS GENERALES DEL BODY
           ========================================== */
        body {
            background-color: #000 !important; /* Fondo negro sólido para toda la página, forzado con !important */
            color: white; /* Color del texto */
            min-height: 100vh; /* Altura mínima de la pantalla */
            display: flex; /* Flexbox para centrar contenido */
            align-items: center; /* Centrado vertical */
            justify-content: center; /* Centrado horizontal */
            padding: 4px; /* Espaciado alrededor del contenido */
            flex-direction: column; /* Contenido en columna */
            font-family: 'Inter', sans-serif; /* Fuente principal */
        }

        /* ==========================================
           CONTENEDORES DE PISTA
           ========================================== */
        /* Contenedor principal para una pista */
        .track-container {
            display: flex;
            flex-direction: column;
            align-items: center; /* Centrar las pistas si no ocupan todo el ancho */
            width: 100%; /* Ocupa el 100% del contenedor padre */
            margin-bottom: 20px; /* Espacio entre pistas */
        }

        /* La ventana de visualización de la pista (fixed viewport) */
        .race-track-viewport {
            border-radius: 8px;
            position: relative;
            overflow: hidden; /* Esto es clave para el efecto de scroll */
            width: 100%; /* ¡Ajustado para ocupar todo el ancho de la consola! */
            max-width: 600px; /* Ancho máximo para cada pista */
            height: 100px; /* Altura fija para la sección de la pista */
            background-color: #333; /* Fondo base de la pista */
            border: 2px solid #555; /* Borde sutil para la pista */
        }

        /* ==========================================
           AUTOS
           ========================================== */
        .car {
            width: 20px; /* Ancho del auto */
            height: 10px; /* Alto del auto */
            background-color: #f00; /* Color rojo por defecto para carro A */
            border-radius: 3px; /* Bordes redondeados del auto */
            position: absolute;
            transform: translateY(-50%); /* Ajuste fino para centrado vertical */
            transition: none; /* Elimina la transición CSS, el movimiento será por JS */
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.7); /* Brillo para el auto A */
            z-index: 5; /* Por encima de start line y decoraciones */
            /* top y left se establecerán en JS o en clases específicas */
        }

        /* Posiciones verticales por carril (ahora SIEMPRE sobre la pista) */
        .car.car-A {
            top: 30%; /* carril superior */
        }
        .car.car-B {
            top: 70%; /* carril inferior */
            background-color: #00f; /* Color azul para carro B */
            box-shadow: 0 0 5px rgba(0, 0, 255, 0.7); /* Brillo para el auto B */
        }

        /* ==========================================
           LÍNEA DE LARGADA + DIVISORIAS
           ========================================== */
        .start-area {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 70px; /* Ancho para contener el texto y la línea */
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 2; /* Por debajo de autos, por encima del fondo */
            /* left se establecerá y actualizará en JS */
        }

        .start-text-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            position: relative;
        }

        .start-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg); /* Centrar y rotar */
            color: white;
            font-size: 0.8rem;
            font-family: 'Press Start 2P', cursive;
            z-index: 4; /* Texto encima de la línea punteada */
            white-space: nowrap;
        }

        .start-dotted-line {
            width: 5px;
            background: repeating-linear-gradient(to bottom, yellow 0, yellow 5px, transparent 5px, transparent 10px);
            border-radius: 2px;
            height: 100%;
            flex-shrink: 0;
            opacity: 0.9;
            margin-left: 5px;
            z-index: 3; /* Debajo de autos */
        }

        .lane-divider-visual { /* Línea divisoria horizontal con scroll */
            position: absolute; /* Para que su background-position-x funcione correctamente */
            height: 2px; /* Grosor de la línea discontinua */
            background: repeating-linear-gradient(to right, #ccc 0, #ccc 10px, transparent 10px, transparent 20px); /* Patrón de línea discontinua */
            border-radius: 1px;
            opacity: 0.8;
            top: 50%; /* Centrado verticalmente */
            transform: translateY(-50%); /* Ajuste fino */
            left: 0; /* Ocupa todo el ancho */
            width: 100%; /* El 100% del viewport */
            z-index: 1; /* Por debajo de autos y largada */
            /* background-position-x se maneja por JS */
        }

        /* ==========================================
           FRANJAS ROJAS/BLANCAS LATERALES (bordes de la pista)
           ========================================== */
        .track-stripe {
            position: absolute;
            height: 5px; /* Grosor de la línea */
            width: 100%; /* Ocupa todo el ancho */
            background: repeating-linear-gradient(to right, 
                #ff0000 0px,    /* Rojo */
                #ff0000 15px,   /* Rojo hasta 15px */
                #ffffff 15px,   /* Blanco empieza en 15px */
                #ffffff 30px    /* Blanco hasta 30px */
            );
            z-index: 0; /* Detrás de todo */
            background-position-x: 0; /* Se anima por JS */
        }
        .track-stripe.top-border { top: 0; }
        .track-stripe.bottom-border { bottom: 0; }

        /* ==========================================
           CONTENEDOR PRINCIPAL (marco césped arcade)
           ========================================== */
        .main-container-wrapper {
            border: 4px solid #ffffff; /* Borde blanco */
            box-shadow: 0 0 15px 5px rgba(255, 255, 255, 0.4); /* Sombra blanca suave */
            
            /* Fondo césped pixelado */
            background-color: #4CAF50; /* Base mid-green */
            background-image: 
                radial-gradient(circle at 10% 20%, #388E3C 1px, transparent 2px),
                radial-gradient(circle at 50% 70%, #388E3C 1px, transparent 2px),
                radial-gradient(circle at 80% 30%, #388E3C 1px, transparent 2px),
                radial-gradient(circle at 30% 50%, #388E3C 1px, transparent 2px),
                radial-gradient(circle at 60% 10%, #388E3C 1px, transparent 2px),
                radial-gradient(circle at 25% 85%, #66BB6A 1px, transparent 2px),
                radial-gradient(circle at 75% 5%, #66BB6A 1px, transparent 2px),
                radial-gradient(circle at 5% 40%, #66BB6A 1px, transparent 2px),
                radial-gradient(circle at 95% 60%, #66BB6A 1px, transparent 2px),
                radial-gradient(circle at 40% 95%, #66BB6A 1px, transparent 2px),
                radial-gradient(circle at 15% 5%, rgba(76, 175, 80, 0.7) 2px, transparent 3px),
                radial-gradient(circle at 70% 90%, rgba(76, 175, 80, 0.7) 2px, transparent 3px),
                radial-gradient(circle at 5% 50%, rgba(76, 175, 80, 0.7) 2px, transparent 3px);
            background-size: 20px 20px;
            background-repeat: repeat;

            padding: 40px 0; /* padding vertical */
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px; /* Igual que el ancho máximo de las pistas */
            margin: auto;
            position: relative; /* Para sombras y semáforo */
        }

        /* ==========================================
           SEMÁFORO
           ========================================== */
        #traffic-light {
            background-color: #333; /* Fondo oscuro del semáforo */
            border: 2px solid #555;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 6; /* Sobre todo */
        }
        .light-row { margin-bottom: 5px; }
        .light {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #222; /* Estado apagado */
            border: 1px solid #555;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
            transition: background-color 0.2s, box-shadow 0.2s; /* Suave */
        }
        .light.red-on {
            background-color: #f00;
            box-shadow: 0 0 10px #f00, inset 0 0 5px #f00;
        }
        .light.green-on {
            background-color: #0f0;
            box-shadow: 0 0 10px #0f0, inset 0 0 5px #0f0;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4 font-inter flex-col">

    <!-- Contenedor principal con bordes blancos brillantes -->
    <div class="main-container-wrapper">
        <!-- Contenedor de las pistas de carrera -->
        <div id="tracks-container" class="w-full flex flex-col items-center">
            <!-- Plantilla para una pista de carrera (se clonará con JS) -->
            <template id="track-template">
                <div class="track-container">
                    <div class="race-track-viewport"> <!-- La ventana de visualización fija de la pista -->
                        <!-- Franjas rojas y blancas -->
                        <div class="track-stripe top-border"></div>
                        <div class="track-stripe bottom-border"></div>

                        <!-- Start Area (elemento que se desplaza y desaparece) -->
                        <div class="start-area">
                            <div class="start-text-container">
                                <span class="start-text font-arcade">START</span>
                            </div>
                            <div class="start-dotted-line"></div>
                        </div>

                        <!-- Línea divisoria (fondo que se desplaza) -->
                        <div class="lane-divider-visual"></div>

                        <!-- Autos (posición fija en el viewport, simulando avance) -->
                        <div class="car car-A"></div>
                        <div class="car car-B"></div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Semáforo de carrera -->
        <div id="traffic-light" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 flex flex-col items-center p-4 rounded-lg bg-gray-800 border-2 border-gray-600 hidden">
            <div class="light-row flex space-x-2 mb-2">
                <div class="light red-light"></div>
                <div class="light red-light"></div>
                <div class="light red-light"></div>
                <div class="light red-light"></div>
                <div class="light red-light"></div>
            </div>
            <div class="light green-light"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // DATOS Y CONSTANTES
        // ==========================================
        const staticData = [
            {"pareja": "ALONSO CASTAÑO - ALEXIA RIVAS", "agente1Nombre": "ALONSO CASTAÑO", "agente1Puntaje": 385, "agente2Nombre": "ALEXIA RIVAS", "agente2Puntaje": 520},
            {"pareja": "DELFINA SAEZ - ANDREA VEDIA", "agente1Nombre": "DELFINA SAEZ", "agente2Nombre": "ANDREA VEDIA", "agente2Puntaje": 355, "agente1Puntaje": 50},
            {"pareja": "ASTRID ARIAS BORQUEZ - LEONELLA PORCEL", "agente1Nombre": "ASTRID ARIAS BORQUEZ", "agente1Puntaje": 0, "agente2Nombre": "LEONELLA PORCEL", "agente2Puntaje": 120}
        ];

        const MAX_SCORE_FOR_VISUAL = 600; 
        // La posición X donde la línea de largada se verá en el viewport (100px desde la izquierda)
        const START_LINE_VISUAL_X = 100; 
        // Pequeño offset para que el auto con 0 puntos esté un poco antes de la línea de largada (25px)
        const CAR_START_OFFSET_FROM_LINE = 25; 

        // La posición inicial X (borde izquierdo) de los autos dentro del viewport.
        // Se calcula para que el auto esté 25px antes de la línea de largada visual.
        const CAR_BASE_VIEWPORT_X = START_LINE_VISUAL_X - CAR_START_OFFSET_FROM_LINE; // 100 - 25 = 75px
        
        // El rango que el auto puede "avanzar" en la pista, desde su posición base hasta el final (considerando su ancho).
        // Max ancho de pista (600px) - ancho del auto (20px) - posición inicial del auto (75px) = 505px
        const CAR_LEAD_RANGE = (600 - 20) - CAR_BASE_VIEWPORT_X; 

        const LANE_DIVIDER_PATTERN_WIDTH = 40; 
        const FINAL_TRACK_SCROLL_SPEED = 5; 
        const INITIAL_TRACK_SCROLL_SPEED = 0.1;
        const ACCELERATION_RATE = 0.05;
        
        // La posición inicial (borde izquierdo) del start-area (70px de ancho).
        // Se calcula para que su línea punteada (borde derecho) coincida con START_LINE_VISUAL_X.
        // START_LINE_VISUAL_X (100px) - Ancho del start-area (70px) = 30px
        const ZERO_POINT_CAR_STATIC_X_START_AREA = START_LINE_VISUAL_X - 70; 

        // Duración de la salida desde la largada hasta la posición por puntaje
        const LAUNCH_DURATION_MS = 2000; // 2 segundos para que se note la aceleración

        // ==========================================
        // ESTADO MUTABLE
        // ==========================================
        let animationFrameIds = [];
        let laneDividerScrollOffsets = [];
        let startAreaCurrentX = [];
        let startAreaDisappeared = [];
        let trackCurrentSpeeds = [];
        const trackElements = []; 
        let trackStripeScrollOffsets = []; // offsets de las franjas laterales

        // Semáforo
        let trafficLightsElement;
        let redLightsElements;
        let greenLightElement;
        let lightSequenceIndex = 0;
        let lightInterval;
        const LIGHT_DELAY_MS = 600; // Retraso entre cada luz

        // Flag de carrera
        let raceStarted = false; // Antes del verde = false. Al largar = true.

        // ==========================================
        // REFERENCIAS DOM
        // ==========================================
        const tracksContainer = document.getElementById('tracks-container');
        const trackTemplate = document.getElementById('track-template');

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        function initializeTracksAndAnimations() {
            // Limpiar pistas y animaciones existentes si se llama por un redimensionamiento o reinicio
            animationFrameIds.forEach(cancelAnimationFrame);
            animationFrameIds = [];
            laneDividerScrollOffsets = [];
            startAreaCurrentX = [];
            startAreaDisappeared = [];
            trackCurrentSpeeds = []; 
            trackStripeScrollOffsets = []; 

            tracksContainer.innerHTML = ''; // Limpiar el contenedor de pistas
            trackElements.length = 0; // Limpiar el array de elementos de pista

            // Crear dinámicamente las pistas a partir de la plantilla
            for (let i = 0; i < staticData.length; i++) {
                const trackClone = trackTemplate.content.cloneNode(true);
                tracksContainer.appendChild(trackClone);
                
                // Inicializar estados para la nueva pista
                laneDividerScrollOffsets.push(0); 
                startAreaCurrentX.push(ZERO_POINT_CAR_STATIC_X_START_AREA); 
                startAreaDisappeared.push(false);
                trackCurrentSpeeds.push(INITIAL_TRACK_SCROLL_SPEED); // Velocidad inicial lenta
                trackStripeScrollOffsets.push(0);
            }

            // Obtener referencias a los elementos de las pistas recién creadas
            document.querySelectorAll('.track-container').forEach(trackEl => {
                trackElements.push(trackEl);
            });

            // Colocar autos EN LA LARGADA (todos iguales) antes del verde
            setCarsAtStartLine(); 

            // Iniciar la secuencia del semáforo
            startTrafficLightSequence();
        }

        // ==========================================
        // POSICIONAR AUTOS
        // ==========================================
        function setCarsAtStartLine() {
            trackElements.forEach((trackEl) => {
                const carA = trackEl.querySelector('.car-A');
                const carB = trackEl.querySelector('.car-B');

                carA.style.left = `${CAR_BASE_VIEWPORT_X}px`;
                carB.style.left = `${CAR_BASE_VIEWPORT_X}px`;

                carA.style.display = 'block';
                carB.style.display = 'block';
            });
        }

        // Recalcula la posición final según puntaje (por si la ventana cambia)
        function setCarsToScorePositions() {
            trackElements.forEach((trackEl, i) => {
                const carA = trackEl.querySelector('.car-A');
                const carB = trackEl.querySelector('.car-B');
                const pairData = staticData[i];
                if (!pairData) return;

                const carAFinalX = CAR_BASE_VIEWPORT_X + (pairData.agente1Puntaje / MAX_SCORE_FOR_VISUAL) * CAR_LEAD_RANGE;
                const carBFinalX = CAR_BASE_VIEWPORT_X + (pairData.agente2Puntaje / MAX_SCORE_FOR_VISUAL) * CAR_LEAD_RANGE;

                carA.style.left = `${carAFinalX}px`;
                carB.style.left = `${carBFinalX}px`;

                carA.style.display = 'block';
                carB.style.display = 'block';
            });
        }

        // Movimiento desde la largada hasta la posición real por puntaje
        function animateCarsToFinalPositions(pairData, carA, carB) {
            const carAFinalX = CAR_BASE_VIEWPORT_X + (pairData.agente1Puntaje / MAX_SCORE_FOR_VISUAL) * CAR_LEAD_RANGE;
            const carBFinalX = CAR_BASE_VIEWPORT_X + (pairData.agente2Puntaje / MAX_SCORE_FOR_VISUAL) * CAR_LEAD_RANGE;

            const startTime = performance.now();
            const duration = LAUNCH_DURATION_MS; // ms

            // Easing (aceleración suave): easeOutCubic
            const ease = (t) => 1 - Math.pow(1 - t, 3);

            function moveCars(now) {
                const elapsed = now - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = ease(progress);

                // Interpolación desde la largada hasta la posición final por puntos
                carA.style.left = `${CAR_BASE_VIEWPORT_X + (carAFinalX - CAR_BASE_VIEWPORT_X) * eased}px`;
                carB.style.left = `${CAR_BASE_VIEWPORT_X + (carBFinalX - CAR_BASE_VIEWPORT_X) * eased}px`;

                if (progress < 1) {
                    requestAnimationFrame(moveCars);
        }
            }

            requestAnimationFrame(moveCars);
        }        

        // ==========================================
        // BUCLE DE ANIMACIÓN DE LA PISTA
        // ==========================================
        function animateRaceLoop(trackIndex, raceTrackViewport, carA, carB, startArea, laneDividerVisual, topStripe, bottomStripe, pairData) {
            if (!pairData) return; // No animar si no hay datos

            function gameLoop() {
                // Aumentar la velocidad de la pista progresivamente hasta la velocidad final deseada
                if (trackCurrentSpeeds[trackIndex] < FINAL_TRACK_SCROLL_SPEED) {
                    trackCurrentSpeeds[trackIndex] = Math.min(trackCurrentSpeeds[trackIndex] + ACCELERATION_RATE, FINAL_TRACK_SCROLL_SPEED);
                }

                // Actualizar la posición de scroll de la línea divisoria (background)
                laneDividerScrollOffsets[trackIndex] = (laneDividerScrollOffsets[trackIndex] - trackCurrentSpeeds[trackIndex]) % LANE_DIVIDER_PATTERN_WIDTH;
                laneDividerVisual.style.backgroundPositionX = `${laneDividerScrollOffsets[trackIndex]}px`;

                // Actualizar la posición de scroll de las franjas laterales (background)
                trackStripeScrollOffsets[trackIndex] = (trackStripeScrollOffsets[trackIndex] - trackCurrentSpeeds[trackIndex]) % LANE_DIVIDER_PATTERN_WIDTH;
                topStripe.style.backgroundPositionX = `${trackStripeScrollOffsets[trackIndex]}px`;
                bottomStripe.style.backgroundPositionX = `${trackStripeScrollOffsets[trackIndex]}px`;

                // Actualizar la posición de la startArea (se mueve y no regresa)
                if (!startAreaDisappeared[trackIndex]) {
                    startAreaCurrentX[trackIndex] -= trackCurrentSpeeds[trackIndex];
                    startArea.style.left = `${startAreaCurrentX[trackIndex]}px`;

                    // Si la startArea se fue completamente de la pantalla, la ocultamos y marcamos como desaparecida
                    if (startAreaCurrentX[trackIndex] + startArea.offsetWidth < 0) {
                        startArea.style.display = 'none';
                        startAreaDisappeared[trackIndex] = true;
                    }
                }

                // Asegurar que ambos autos siempre estén visibles (su X la gestiona otra lógica)
                carA.style.display = 'block';
                carB.style.display = 'block';

                // Solicitar el siguiente frame de animación
                animationFrameIds[trackIndex] = requestAnimationFrame(gameLoop);
            }

            // Iniciar el bucle de animación
            animationFrameIds[trackIndex] = requestAnimationFrame(gameLoop);
        }

        // ==========================================
        // SEMÁFORO TIPO F1
        // ==========================================
        function startTrafficLightSequence() {
            trafficLightsElement = document.getElementById('traffic-light');
            redLightsElements = trafficLightsElement.querySelectorAll('.red-light');
            greenLightElement = trafficLightsElement.querySelector('.green-light');

            trafficLightsElement.classList.remove('hidden'); // Mostrar semáforo

            // Reset de luces
            redLightsElements.forEach(light => light.classList.remove('red-on'));
            greenLightElement.classList.remove('green-on'); 

            lightSequenceIndex = 0;

            lightInterval = setInterval(() => {
                if (lightSequenceIndex < redLightsElements.length) {
                    // Encender rojas secuencialmente
                    redLightsElements[lightSequenceIndex].classList.add('red-on');
                    lightSequenceIndex++;
                } else if (lightSequenceIndex === redLightsElements.length) {
                    // Todas las rojas encendidas, ahora apagarlas y encender la verde
                    redLightsElements.forEach(light => light.classList.remove('red-on'));
                    greenLightElement.classList.add('green-on');
                    lightSequenceIndex++; // señal de que la verde está encendida
                    
                    // Iniciar la carrera tras un breve delay para que se vea la verde
                    setTimeout(() => {
                        trafficLightsElement.classList.add('hidden'); // Ocultar semáforo
                        clearInterval(lightInterval); // Detener la secuencia

                        raceStarted = true; // ¡Largamos!
                        
                        // Animación de salida + scroll de pista para todas las pistas
                        trackElements.forEach((trackEl, i) => {
                            const carA = trackEl.querySelector('.car-A');
                            const carB = trackEl.querySelector('.car-B');
                            const startArea = trackEl.querySelector('.start-area');
                            const laneDividerVisual = trackEl.querySelector('.lane-divider-visual'); 
                            const raceTrackViewport = trackEl.querySelector('.race-track-viewport');
                            const topStripe = trackEl.querySelector('.track-stripe.top-border');
                            const bottomStripe = trackEl.querySelector('.track-stripe.bottom-border');
                            
                            // 1) Mover autos desde la largada hasta su posición final por puntaje
                            animateCarsToFinalPositions(staticData[i], carA, carB);

                            // 2) Empezar el scroll de la pista
                            animateRaceLoop(i, raceTrackViewport, carA, carB, startArea, laneDividerVisual, topStripe, bottomStripe, staticData[i]);
                        });
                    }, LIGHT_DELAY_MS * 1.5); // Un poco más de tiempo para ver la verde
                }
            }, LIGHT_DELAY_MS);
        }

        // ==========================================
        // EVENTOS
        // ==========================================
        document.addEventListener('DOMContentLoaded', initializeTracksAndAnimations);

        // En un resize: si la carrera NO comenzó aún, mantener autos en la largada;
        // si ya comenzó, recalcular posiciones según puntaje para que se adapten al ancho fijo de viewport (600px)
        window.addEventListener('resize', () => {
            if (!raceStarted) {
                setCarsAtStartLine();
            } else {
                setCarsToScorePositions();
            }
        });
    </script>
</body>
</html>

